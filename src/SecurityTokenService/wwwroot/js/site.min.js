function uuid(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(n){const t=Math.random()*16|0,i=n==="x"?t:t&3|8;return i.toString(16)})}function randomKey(){return Array.from({length:6},()=>{const n="0123456zKLM7deklmnfghxKLMNOy34567zABCDEFijklmnopqrstuvwGHIJ67zABOyzKLMNOPQRS89abcTUVWXYZ";return n.charAt(Math.floor(Math.random()*n.length))}).join("")}function AESEnc(n,t){const i=CryptoJS.enc.Utf8.parse(n),r=CryptoJS.enc.Utf8.parse(t),u=CryptoJS.AES.encrypt(r,i,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return u.ciphertext.toString(CryptoJS.enc.Base64)}function initError(){const n=parseInt(getQueryParam("errorId"));printError(n)}function printError(n){switch(n){case 4001:$("#message").text("不支持双因素认证");break;case 4002:$("#message").text("用户被禁止登录");break;case 4003:$("#message").text("用户被锁定");break;case 4004:$("#message").text("用户名或密码不正确");break;case 4005:$("#message").text("不支持 NativeClient");break;case 4006:$("#message").text("返回地址不合法");break;case 4007:$("#message").text("选择的操作不正确");break;case 4008:$("#message").text("没有 Scope 可匹配");break;case 4009:$("#message").text("客户端标识出错");break;case 4010:$("#message").text("授权请求链接不正确");break;case 4011:$("#message").text("登录失败");break;default:$("#message").text("未知错误")}}function initRedirect(){const n=getQueryParam("redirectUrl");n&&(window.location.href=n)}function initConsent(){const n=getQueryParam("returnUrl");$.ajax({xhrFields:{withCredentials:!0},type:"GET",url:"consent?returnUrl="+n,success:function(n){const t=n.data;if($("#clientName").prepend(t.clientName),t.clientLogoUrl?$("#clientLogoUrl").attr("src",t.clientLogoUrl):$("#clientLogoUrl").remove(),$("#returnUrl").val(t.returnUrl),t.identityScopes&&t.identityScopes.length>0){for(let n=0;n<t.identityScopes.length;++n){const i=t.identityScopes[n];appendScope("identityScopeList",i)}$("#identityScopes").show()}if(t.resourceScopes&&t.resourceScopes.length>0){for(let n=0;n<t.resourceScopes.length;++n){const i=t.resourceScopes[n];appendScope("resourceScopes",i)}$("#resourceScopes").show()}t.allowRememberConsent?$("#rememberConsentDiv").show():$("#rememberConsent").val(!1);t.clientUrl&&($("#client").attr("href",t.clientUrl),$("#clientName2").text(t.clientName))},error:function(){}})}function appendScope(n,t){const i=`<li class="list-group-item">
<label>
 <input class="consent-scopecheck" type="checkbox"
    name="ScopesConsented"
    id="scopes_${t.name}"
    value="${t.name}"
    ${t.checked?'checked="checked"':""}
    ${t.required?'disabled="disabled"':""} />
    <strong>${t.displayName}</strong>
    ${t.required?'<input type="hidden" name="ScopesConsented" value="'+t.name+'"/>':""}
</label>
${scope.required ? "<span><em>(required)</em></span>" : ""}
${
  scope.description
    ? '<div class="consent-description"><label for="scopes_' +
      scope.name +
      '">' +
      scope.description +
      "</label></div>"
    : ""
}
</li>`;$("#"+n).append(i)}function initDiagnostics(){$.ajax({xhrFields:{withCredentials:!0},type:"GET",url:"diagnostics",success:function(n){if(n.claims&&n.claims.length>0){const t=$("#claims");for(let i=0;i<n.claims.length;++i){const r=n.claims[i];t.append(`<dt>${r.type}</dt>`);t.append(`<dd>${r.value}</dd>`)}}if(n.properties&&n.properties.length>0){const t=$("#properties");for(let i=0;i<n.properties.length;++i){const r=n.properties[i];t.append(`<dt>${r.key}</dt>`);t.append(`<dd>${r.value}</dd>`)}}},error:function(n){n.status===401&&(window.location.href="login.html?returnUrl=/diagnostics.html")}})}function initLoggedOut(){const n=getQueryParam("postLogoutRedirectUri"),i=getQueryParam("clientName"),t=getQueryParam("signOutIframeUrl"),r=getQueryParam("automaticRedirectAfterSignOut");n&&($("#clientName").text(i),$("#postLogoutRedirect").show(),r&&(window.location=n));t?($("#signOutIframe").show(),$("#signOutIframeUrl").attr("src",t)):window.location="/"}function isForm(n){return n instanceof HTMLFormElement}function formToJson(n){var t={},i=$(n).serializeArray();return $.each(i,function(n,i){t[i.name]?($.isArray(t[i.name])||(t[i.name]=[t[i.name]]),t[i.name].push(i.value)):t[i.name]=i.value}),t}function buildRequest(n,t,i){const u=isForm(t)?formToJson(t):t;i&&(u.returnUrl=i);const f=uuid(),e=f.split("");e.splice(10,0,randomKey());n.xhrFields={withCredentials:!0};n.contentType="application/json";const r=n.headers||{};r["Z-Encrypt-Version"]="v1.1";r["Z-Encrypt-Key"]=e.join("");n.headers=r;const o=JSON.stringify(u);return n.data=AESEnc(f,o),n}function initLogin(){$.validator.setDefaults({errorContainer:"div.error",errorLabelContainer:$("#form div.error"),wrapper:"label"});const n=$("#message");$("#sendSmsBtn").click(function(){n.hide();const t=$("#phoneNumber").val(),i=$("input[name='captchaCode']:visible").val();if(!t||t.length>24||t.length<11)n.text("手机号不正确"),n.show();else if(i){const r=buildRequest({type:"POST",url:"account/sendCode"},{phoneNumber:t,countryCode:"+86",scenario:"Login",captchaCode:i});$.ajax(Object.assign(r,{dataType:"json",success:function(t){if(t.code!==200){if(t.message){const i=t.message.split("\n");let r="";for(let n=0;n<i.length;++n){const t=i[n];t&&(r+=n===0?t:"<br/>"+t)}n.html(r)}else printError(t.code);n.show()}else $("#sendSmsBtn").popover()},error:function(){n.show();n.text("服务器出小差")}}))}else n.text("验证码不正确"),n.show()});$("#loginButton").click(function(){const n=$("#message");n.hide();$("#form").validate({rules:{username:{required:!0},password:{required:!0}},messages:{username:{required:"用户名不能为空"},password:{required:"请输入密码"}},submitHandler:function(t){let i=getQueryParam("returnUrl");i=i?i:"";const r=buildRequest({type:"POST",url:"account/login"},t,i);$.ajax(Object.assign(r,{success:function(t){if(t.location){const i=t.location;let n=window;while(n!==n.top)n=n.top;n.location.href=i}else if(t.code!==200){if(t.message){const i=t.message.split("\n");let r="";for(let n=0;n<i.length;++n){const t=i[n];t&&(r+=n===0?t:"<br/>"+t)}n.html(r)}else printError(t.code);n.show()}else window.location.href="/"},error:function(){n.text("服务器出小差");n.show()}}))}})});$("#smsLoginBtn").click(function(){n.hide();$("#smsForm").validate({rules:{phoneNumber:{required:!0},verifyCode:{required:!0}},messages:{phoneNumber:{required:"手机号不能为空"},verifyCode:{required:"请输入验证码"}},submitHandler:function(t){let i=getQueryParam("returnUrl");i=i?i:"";const r=buildRequest({type:"POST",url:"account/LoginByCode"},t,encodeURIComponent(i));$.ajax(Object.assign(r,{success:function(t){if(t.location){const i=t.location;let n=window;while(n!==n.top)n=n.top;n.location.href=i}else if(t.code!==200){if(t.message){const i=t.message.split("\n");let r="";for(let n=0;n<i.length;++n){const t=i[n];t&&(r+=n===0?t:"<br/>"+t)}n.html(r)}else printError(t.code);n.show()}else window.location.href="/"},error:function(){n.text("服务器出小差");n.show()}}))}})});$("#localAccountTab li").bind("click",function(){setTimeout(function(){refreshCaptcha()},500)});$(".captcha-img").bind("click",refreshCaptcha);refreshCaptcha()}function refreshCaptcha(){$(".captcha-img:visible").attr("src",`api/v1.0/captcha/generate?_t=${Date.now()}`)}function initChangePassword(){$.validator.setDefaults({errorContainer:"div.error",errorLabelContainer:$("#form div.error"),wrapper:"label"});$("#submitButton").click(function(){const n=$("#message");n.hide();$("#form").validate({rules:{username:{required:!0},newPassword:{required:!0,regex:/^(?=.*\d)(?=.*[A-Za-z])(?=.*[^\da-zA-Z\s]).{8,30}$/},oldPassword:{required:!0},confirmNewPassword:{required:!0}},messages:{username:{required:"用户名不能为空"},newPassword:{required:"请输入密码",regex:"密码必须包含字母、数字和特殊符号，最少 8 位"}},submitHandler:function(t){const i=buildRequest({type:"POST",url:"account/resetPassword2"},t);$.ajax(Object.assign(i,{success:function(t){if(t.code!==200)if(n.show(),t.message){const i=t.message.split("\n");let r="";for(let n=0;n<i.length;++n){const t=i[n];t&&(r+=n===0?t:"<br/>"+t)}n.html(r)}else printError(t.code);else window.location.href="/"},error:function(){n.show();n.text("服务器出小差")}}))}})})}function initLogout(){const n=getQueryParam("logoutId");$("#logoutId").val(n)}function initSession(){$.get("session",n=>{if(n.data&&n.data.some(n=>n.type==="sub")){const i=$("#user");i.attr("sub",n.data.sub);let t=n.data.filter(n=>n.type==="name"),r;t.length===0&&(t=n.data.filter(n=>n.type==="email"));r=t[0].value;i.prepend(r);$("#userNav").show()}})}function getQueryParam(n){const t=new URLSearchParams(window.location.search);return t.get(n)}$(document).ready(()=>{const n=location.href;n.indexOf("login.html")>=0?initLogin():n.indexOf("logout.html")>=0?initLogout():n.indexOf("loggedout.html")>=0?initLoggedOut():n.indexOf("diagnostics.html")>=0?(initSession(),initDiagnostics()):n.indexOf("consent.html")>=0?(initSession(),initConsent()):n.indexOf("redirect.html")>=0?initRedirect():n.indexOf("changePassword.html")>=0?initChangePassword():n.indexOf("error.html")>=0?(initSession(),initError()):initSession()});